worker_processes 1;
error_log stderr;
pid nginx.pid;
daemon off;

events {
	worker_connections 768;
}

upstream iguana {
    server 127.0.0.1:9000;
}

http {
	types_hash_max_size 2048;
	include mime.types;
	server {
		listen <%= ENV['PORT'] %>;
		server_name  _;
		root <%= ENV.fetch('root', '/app/www') %>;
		index index.html;

		location / {
			proxy_set_header X-Real-IP $remote_addr;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_set_header Host $http_host;
			proxy_set_header X-NginX-Proxy true;

			proxy_pass http://iguana/;
			proxy_redirect off;			
		}

		### If a bot requests an escaped URL then rewrite the request to SEO44ajax location
		if ($args ~* _escaped_fragment_=) {
			rewrite  ^(.*)$  /seo4ajax/$1  last;
		}

		### SEO4ajax location to handle proxyfication to SEO4Ajax API
		location /seo4ajax/ {
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_set_header Host api.seo4ajax.com;
			proxy_pass http://api.seo4ajax.com/f006894768900ef61ed2064ffd21c4ed/;
		}
	}
}
